<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Editar Endere√ßos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- TailwindCSS (ou seu CSS principal) -->
  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    rel="stylesheet"
  />

  <!-- FontAwesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    integrity="sha512-dym6Y5UDnjo1uejY9zF6xiFlJZQ6hM3OeXq3YQZj6fJycG8z9f/8lu+CyT9ZV1JzlYwukgRoxb+Zjz7zjpM6eQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <style>
    /* Estilos m√≠nimos */
    .address-item {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: flex-start;
      position: relative;
    }
    .menu-btn, .edit-btn {
      background: none;
      border: none;
      cursor: pointer;
    }
    .menu-btn { font-size: 1.2rem; color: #555; }
    .edit-btn { font-size: 1rem; color: #2980b9; }
    .dropdown-item:hover { background: #f0f0f0; }
    #loader {
      position: fixed; top:0; left:0;
      width:100%; height:100%;
      background: rgba(255,255,255,0.8) url('loader.gif') center no-repeat;
      z-index:9999;
    }
    #loader.hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

  <div class="bg-white w-full max-w-md rounded-lg shadow-lg">
    <header class="flex items-center p-4 border-b">
      <button id="backBtn" class="mr-2 text-gray-600 hover:text-gray-900">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1 class="text-lg font-semibold">Editar Endere√ßos</h1>
    </header>

    <main class="p-4">
      <button id="newAddressBtn"
              class="mb-4 px-4 py-2 bg-yellow-700 text-white rounded hover:bg-yellow-800">
        + Novo Endere√ßo
      </button>

      <p class="mb-2 text-gray-700">Selecione seu endere√ßo de entrega</p>
      <ul id="addressList" class="mb-4"></ul>

      <button id="saveBtn"
              class="w-full px-4 py-2 bg-yellow-700 text-white rounded hover:bg-yellow-800">
        Salvar
      </button>
    </main>
  </div>

  <!-- Loader -->
  <div id="loader" class="hidden"></div>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Ativa o loader
    function showLoader() {
      document.getElementById('loader').classList.remove('hidden');
    }

    // Esconde o loader
    function hideLoader() {
      document.getElementById('loader').classList.add('hidden');
    }

    /**
     * Busca os endere√ßos do usu√°rio via WhatsApp.
     * @param {string} whatsapp 
     * @returns {Promise<AddressDto[]>}
     */
    async function fetchUserAddresses(whatsapp) {
      showLoader();
      try {
        const resp = await fetch('/api/Usuario/GetAddressesByWhatsApp', {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numero: whatsapp })
        });
        if (resp.status === 204) return [];
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return await resp.json();
      } finally {
        hideLoader();
      }
    }

    /**
     * Renderiza a lista de endere√ßos no UL.
     * @param {AddressDto[]} addresses 
     */
     function renderAddressList(addresses) {
  const ul = document.getElementById('addressList');
  ul.innerHTML = '';

  if (addresses.length === 0) {
    ul.innerHTML = '<li class="text-gray-500">Nenhum endere√ßo cadastrado.</li>';
    return;
  }

  addresses.forEach(addr => {
    // cria o LI
    const li = document.createElement('li');
    li.className = 'address-item';
    li.style.position = 'relative';
    li.style.padding = '1rem';
    li.style.borderBottom = '1px solid #e2e8f0';
    li.style.display = 'flex';
    li.style.alignItems = 'flex-start';

    // conte√∫do principal
    const info = document.createElement('div');
    info.style.flex = '1';
    info.style.paddingRight = '4rem';
    info.innerHTML = `
      <input
        type="radio" name="selectedAddress"
        id="addr-${addr.id}" value="${addr.id}"
        ${addr.padrao ? 'checked' : ''}
      />
      <label for="addr-${addr.id}" style="margin-left:0.5rem; line-height:1.4;">
        <strong>${addr.bairro}, ${addr.numero}</strong><br/>
        ${addr.cidade} ‚Äì ${addr.uf.toUpperCase()}<br/>
        ${addr.referencia ? `<em>${addr.referencia}</em><br/>` : ''}
        <small>${addr.distanciaKm.toFixed(1)} km ‚Ä¢ ${addr.tempoMinutos} min ‚Ä¢ R$ ${addr.frete.toFixed(2)}</small>
      </label>
    `;
    li.appendChild(info);

    // bot√£o editar
    const btnEdit = document.createElement('button');
    btnEdit.textContent = '‚úèÔ∏è Editar';
    btnEdit.style.position = 'absolute';
    btnEdit.style.top = '1rem';
    btnEdit.style.right = '5rem';
    btnEdit.style.background = 'none';
    btnEdit.style.border = 'none';
    btnEdit.style.cursor = 'pointer';
    btnEdit.style.color = '#2980b9';
    btnEdit.addEventListener('click', () => editAddress(addr.id));
    li.appendChild(btnEdit);

    // bot√£o de op√ß√µes (excluir dropdown)
    const btnMenu = document.createElement('button');
    btnMenu.textContent = '‚ãÆ';
    btnMenu.style.position = 'absolute';
    btnMenu.style.top = '0.75rem';
    btnMenu.style.right = '1rem';
    btnMenu.style.background = 'none';
    btnMenu.style.border = 'none';
    btnMenu.style.cursor = 'pointer';
    btnMenu.style.fontSize = '1.2rem';
    li.appendChild(btnMenu);

    // dropdown excluir
    const dd = document.createElement('div');
    dd.id = `dropdown-${addr.id}`;
    dd.style.display = 'none';
    dd.style.position = 'absolute';
    dd.style.top = '2.5rem';
    dd.style.right = '1rem';
    dd.style.background = '#fff';
    dd.style.border = '1px solid #ccc';
    dd.style.borderRadius = '6px';
    dd.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
    dd.style.zIndex = '10';
    const itemExcluir = document.createElement('button');
    itemExcluir.textContent = 'üóëÔ∏è Excluir';
    itemExcluir.style.padding = '8px 16px';
    itemExcluir.style.width = '100%';
    itemExcluir.style.textAlign = 'left';
    itemExcluir.style.border = 'none';
    itemExcluir.style.background = 'none';
    itemExcluir.style.cursor = 'pointer';
    itemExcluir.style.color = '#c0392b';
    itemExcluir.addEventListener('click', () => deleteAddress(addr.id));
    dd.appendChild(itemExcluir);
    li.appendChild(dd);

    // toggle dropdown
    btnMenu.addEventListener('click', e => {
      e.stopPropagation();
      document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
      dd.style.display = 'block';
    });

    ul.appendChild(li);
  });

  // fechar qualquer dropdown ao clicar fora
  document.addEventListener('click', () => {
    document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
  });
}

      const ul = document.getElementById('addressList');
      ul.innerHTML = '';

      if (addresses.length === 0) {
        ul.innerHTML = '<li class="text-gray-500">Nenhum endere√ßo cadastrado.</li>';
        return;
      }

      addresses.forEach(addr => {
        const li = document.createElement('li');
        li.className = 'address-item';
        li.innerHTML = `
          <div class="flex-1" style="padding-right:3rem;">
            <input
              type="radio"
              name="selectedAddress"
              id="addr-${addr.id}"
              value="${addr.id}"
              ${addr.padrao ? 'checked' : ''}
            />
            <label for="addr-${addr.id}" class="ml-2">
              <strong>${addr.bairro}, ${addr.numero}</strong><br/>
              ${addr.cidade} ‚Äì ${addr.uf.toUpperCase()}<br/>
              ${addr.referencia ? `<em>${addr.referencia}</em><br/>` : ''}
              <small>
                ${addr.distanciaKm.toFixed(1)} km ‚Ä¢ ${addr.tempoMinutos} min ‚Ä¢ R$ ${addr.frete.toFixed(2)}
              </small>
            </label>
          </div>

          <!-- √çcone de editar fixo -->
          <button
            class="edit-btn"
            onclick="editAddress(${addr.id})"
            title="Editar endere√ßo"
            style="position:absolute; top:1rem; right:3rem;"
          >
            <i class="fas fa-edit"></i>
          </button>

          <!-- Bot√£o de op√ß√µes -->
          <button
            class="menu-btn"
            data-id="${addr.id}"
            aria-label="Op√ß√µes"
            style="position:absolute; top:0.75rem; right:1rem;"
          >
            <i class="fas fa-ellipsis-v"></i>
          </button>

          <!-- Dropdown de excluir -->
          <div class="dropdown" id="dropdown-${addr.id}"
               style="display:none; position:absolute; right:1rem; top:2.5rem;
                      background:#fff; border:1px solid #ccc; border-radius:6px;
                      box-shadow:0 2px 6px rgba(0,0,0,0.15); z-index:10;">
            <button
              class="dropdown-item"
              onclick="deleteAddress(${addr.id})"
              style="display:flex; align-items:center; gap:0.5rem;
                     padding:8px 16px; width:100%; text-align:left;
                     border:none; background:none; cursor:pointer; color:#c0392b;"
            >
              <i class="fas fa-trash-alt"></i> Excluir
            </button>
          </div>
        `;
        ul.appendChild(li);
      });

      // Toggle dropdowns
      document.querySelectorAll('.menu-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const id = btn.dataset.id;
          document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
          document.getElementById(`dropdown-${id}`).style.display = 'block';
        });
      });
      document.addEventListener('click', () => {
        document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
      });

      // Bloqueia novo cadastro se tiver 3
      const newBtn = document.getElementById('newAddressBtn');
      if (addresses.length >= 3) {
        newBtn.disabled = true;
        newBtn.style.opacity = '0.6';
        newBtn.style.cursor = 'not-allowed';
        newBtn.onclick = () => {
          Swal.fire({
            icon: 'info',
            title: 'Limite atingido',
            text: 'Voc√™ s√≥ pode cadastrar at√© 3 endere√ßos. Exclua um para adicionar outro.',
            confirmButtonText: 'Entendi'
          });
        };
      } else {
        newBtn.disabled = false;
        newBtn.style.opacity = '1';
        newBtn.style.cursor = 'pointer';
        newBtn.onclick = () => window.location.href = 'register-address.html';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Voltar na seta
      document.getElementById('backBtn').addEventListener('click', () => {
        history.length > 1 ? history.back() : window.location.href = 'index.html';
      });

      const whatsapp = localStorage.getItem('bgHouse_whatsapp');
      const userId   = localStorage.getItem('bgHouse_id');
      if (!whatsapp) return window.location.href = 'identify.html';

      try {
        const addresses = await fetchUserAddresses(whatsapp);
        renderAddressList(addresses);

        document.getElementById('saveBtn').addEventListener('click', () => {
          const sel = document.querySelector('input[name="selectedAddress"]:checked');
          if (!sel) {
            Swal.fire({
              icon: 'warning',
              title: 'Endere√ßo obrigat√≥rio',
              text: 'Selecione um endere√ßo para prosseguir.',
              confirmButtonText: 'Ok'
            });
            return;
          }
          window.location.href = `checkout.html?userId=${userId}&addressId=${sel.value}`;
        });
      } catch (err) {
        console.error('Erro ao buscar endere√ßos:', err);
        window.location.href = 'identify.html';
      }
    });

    // Excluir endere√ßo
    async function deleteAddress(id) {
      const confirmation = await Swal.fire({
        title: 'Deseja excluir este endere√ßo?',
        text: 'Essa a√ß√£o n√£o poder√° ser desfeita.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, excluir',
        cancelButtonText: 'Cancelar'
      });

      if (confirmation.isConfirmed) {
        try {
          const resp = await fetch(`/api/Usuario/DeleteEndereco/${id}`, { method: 'DELETE' });
          if (!resp.ok) throw new Error('Erro ao excluir');
          Swal.fire('Exclu√≠do!', 'Endere√ßo removido com sucesso.', 'success');
          const list = await fetchUserAddresses(localStorage.getItem('bgHouse_whatsapp'));
          renderAddressList(list);
        } catch {
          Swal.fire('Erro', 'N√£o foi poss√≠vel excluir o endere√ßo.', 'error');
        }
      }
    }

    // Editar endere√ßo
    function editAddress(id) {
      window.location.href = `edit-address.html?addressId=${id}`;
    }
  </script>
</body>
</html>
