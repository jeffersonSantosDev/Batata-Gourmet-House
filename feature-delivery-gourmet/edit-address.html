<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Editar Endereços</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- TailwindCSS (ou seu CSS principal) -->
  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    rel="stylesheet"
  />

  <!-- FontAwesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    integrity="sha512-dym6Y5UDnjo1uejY9zF6xiFlJZQ6hM3OeXq3YQZj6fJycG8z9f/8lu+CyT9ZV1JzlYwukgRoxb+Zjz7zjpM6eQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <style>
    /* Estilos mínimos */
    .address-item {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      position: relative;
    }
    .menu-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      position: absolute;
      top: 1rem;
      right: 1rem;
    }
    .dropdown-item:hover {
      background: #f0f0f0;
    }
    #loader {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.8) url('loader.gif') center no-repeat;
      z-index: 9999;
    }
    #loader.hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

  <div class="bg-white w-full max-w-md rounded-lg shadow-lg">
    <header class="flex items-center p-4 border-b">
      <button id="backBtn" class="mr-2 text-gray-600 hover:text-gray-900">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1 class="text-lg font-semibold">Editar Endereços</h1>
    </header>

    <main class="p-4">
      <button id="newAddressBtn"
              class="mb-4 px-4 py-2 bg-yellow-700 text-white rounded hover:bg-yellow-800">
        + Novo Endereço
      </button>

      <p class="mb-2 text-gray-700">Selecione seu endereço de entrega</p>
      <ul id="addressList" class="mb-4"></ul>

      <button id="saveBtn"
              class="w-full px-4 py-2 bg-yellow-700 text-white rounded hover:bg-yellow-800">
        Salvar
      </button>
    </main>
  </div>

  <!-- Loader -->
  <div id="loader" class="hidden"></div>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Ativa o loader
    function showLoader() {
      document.getElementById('loader').classList.remove('hidden');
    }

    // Esconde o loader
    function hideLoader() {
      document.getElementById('loader').classList.add('hidden');
    }

    /**
     * Busca os endereços do usuário via WhatsApp.
     * @param {string} whatsapp 
     * @returns {Promise<AddressDto[]>}
     */
    async function fetchUserAddresses(whatsapp) {
      showLoader();
      try {
        const resp = await fetch('/api/Usuario/GetAddressesByWhatsApp', {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numero: whatsapp })
        });
        if (resp.status === 204) return [];
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return await resp.json();
      } finally {
        hideLoader();
      }
    }

    /**
     * Renderiza a lista de endereços no UL.
     * @param {AddressDto[]} addresses 
     */
     function renderAddressList(addresses) {
  const ul = document.getElementById('addressList');
  ul.innerHTML = '';

  if (addresses.length === 0) {
    ul.innerHTML = '<li class="no-address">Nenhum endereço cadastrado.</li>';
    return;
  }

  addresses.forEach(addr => {
    const li = document.createElement('li');
    li.className = 'address-item';
    li.style.position = 'relative';  // garante posição dos botões

    li.innerHTML = `
      <div class="address-info" style="padding-right:2.5rem;">
        <input
          type="radio"
          name="selectedAddress"
          id="addr-${addr.id}"
          value="${addr.id}"
          ${addr.padrao ? 'checked' : ''}
        />
        <label for="addr-${addr.id}" class="ml-2">
          <strong>${addr.bairro}, ${addr.numero}</strong><br/>
          ${addr.cidade} – ${addr.uf.toUpperCase()}<br/>
          ${addr.referencia ? `<em>${addr.referencia}</em><br/>` : ''}
          <small>
            ${addr.distanciaKm.toFixed(1)} km • ${addr.tempoMinutos} min • R$ ${addr.frete.toFixed(2)}
          </small>
        </label>
      </div>

      <!-- Ícone de editar fixo -->
      <button
        class="edit-btn"
        onclick="editAddress(${addr.id})"
        title="Editar endereço"
        style="
          position:absolute;
          top:1rem;
          right:2.5rem;
          background:none;
          border:none;
          cursor:pointer;
          font-size:1rem;
          color:#2980b9;
        "
      >
        <i class="fas fa-edit"></i>
      </button>

      <!-- Botão de opções / excluir -->
      <button
        class="menu-btn"
        data-id="${addr.id}"
        aria-label="Opções"
        style="
          background:none;
          border:none;
          cursor:pointer;
          position:absolute;
          top:1rem;
          right:1rem;
          font-size:1.2rem;
        "
      >
        <i class="fas fa-ellipsis-v"></i>
      </button>

      <div
        class="dropdown"
        id="dropdown-${addr.id}"
        style="
          display:none;
          position:absolute;
          right:1rem;
          top:2.8rem;
          background:#fff;
          border:1px solid #ccc;
          border-radius:6px;
          box-shadow:0 2px 6px rgba(0,0,0,0.15);
          z-index:10;
        "
      >
        <button
          class="dropdown-item"
          onclick="deleteAddress(${addr.id})"
          style="
            padding:8px 16px;
            width:100%;
            text-align:left;
            border:none;
            background:none;
            cursor:pointer;
            color:#c0392b;
          "
        >
          <i class="fas fa-trash-alt"></i> Excluir
        </button>
      </div>
    `;

    ul.appendChild(li);
  });

  // (o resto do seu código de toggle dropdown e bloqueio de "novo endereço" permanece igual)
}

      const ul = document.getElementById('addressList');
      ul.innerHTML = '';

      if (addresses.length === 0) {
        ul.innerHTML = '<li class="text-gray-500">Nenhum endereço cadastrado.</li>';
        return;
      }

      addresses.forEach(addr => {
        const li = document.createElement('li');
        li.className = 'address-item';
        li.innerHTML = `
          <div>
            <input
              type="radio"
              name="selectedAddress"
              id="addr-${addr.id}"
              value="${addr.id}"
              ${addr.padrao ? 'checked' : ''}
            />
            <label for="addr-${addr.id}" class="ml-2">
              <strong>${addr.bairro}, ${addr.numero}</strong><br/>
              ${addr.cidade} – ${addr.uf.toUpperCase()}<br/>
              ${addr.referencia ? `<em>${addr.referencia}</em><br/>` : ''}
              <small>
                ${addr.distanciaKm.toFixed(1)} km • ${addr.tempoMinutos} min • R$ ${addr.frete.toFixed(2)}
              </small>
            </label>
          </div>
          <button class="menu-btn" data-id="${addr.id}" aria-label="Opções">
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <div class="dropdown" id="dropdown-${addr.id}"
               style="display:none; position:absolute; right:1rem; top:2.5rem;
                      background:#fff; border:1px solid #ccc; border-radius:6px;
                      box-shadow:0 2px 6px rgba(0,0,0,0.15); z-index:10;">
            <button class="dropdown-item" onclick="editAddress(${addr.id})"
                    style="display:flex; align-items:center; gap:0.5rem;
                           padding:8px 16px; width:100%; text-align:left;
                           border:none; background:none; cursor:pointer; color:#2980b9;">
              <i class="fas fa-edit"></i> Editar
            </button>
            <button class="dropdown-item" onclick="deleteAddress(${addr.id})"
                    style="display:flex; align-items:center; gap:0.5rem;
                           padding:8px 16px; width:100%; text-align:left;
                           border:none; background:none; cursor:pointer; color:#c0392b;">
              <i class="fas fa-trash-alt"></i> Excluir
            </button>
          </div>
        `;
        ul.appendChild(li);
      });

      // Toggle dropdowns
      document.querySelectorAll('.menu-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const id = btn.dataset.id;
          document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
          document.getElementById(`dropdown-${id}`).style.display = 'block';
        });
      });
      document.addEventListener('click', () => {
        document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
      });

      // Bloqueia novo cadastro se tiver 3
      const newBtn = document.getElementById('newAddressBtn');
      if (addresses.length >= 3) {
        newBtn.disabled = true;
        newBtn.style.opacity = '0.6';
        newBtn.style.cursor = 'not-allowed';
        newBtn.onclick = () => {
          Swal.fire({
            icon: 'info',
            title: 'Limite atingido',
            text: 'Você só pode cadastrar até 3 endereços. Exclua um para adicionar outro.',
            confirmButtonText: 'Entendi'
          });
        };
      } else {
        newBtn.disabled = false;
        newBtn.style.opacity = '1';
        newBtn.style.cursor = 'pointer';
        newBtn.onclick = () => window.location.href = 'register-address.html';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Voltar na seta
      document.getElementById('backBtn').addEventListener('click', () => {
        history.length > 1 ? history.back() : window.location.href = 'index.html';
      });

      const whatsapp = localStorage.getItem('bgHouse_whatsapp');
      const userId   = localStorage.getItem('bgHouse_id');
      if (!whatsapp) return window.location.href = 'identify.html';

      try {
        const addresses = await fetchUserAddresses(whatsapp);
        renderAddressList(addresses);

        document.getElementById('saveBtn').addEventListener('click', () => {
          const sel = document.querySelector('input[name="selectedAddress"]:checked');
          if (!sel) {
            Swal.fire({
              icon: 'warning',
              title: 'Endereço obrigatório',
              text: 'Selecione um endereço para prosseguir.',
              confirmButtonText: 'Ok'
            });
            return;
          }
          window.location.href = `checkout.html?userId=${userId}&addressId=${sel.value}`;
        });
      } catch (err) {
        console.error('Erro ao buscar endereços:', err);
        window.location.href = 'identify.html';
      }
    });

    // Excluir endereço
    async function deleteAddress(id) {
      const confirmation = await Swal.fire({
        title: 'Deseja excluir este endereço?',
        text: 'Essa ação não poderá ser desfeita.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, excluir',
        cancelButtonText: 'Cancelar'
      });

      if (confirmation.isConfirmed) {
        try {
          const resp = await fetch(`/api/Usuario/DeleteEndereco/${id}`, { method: 'DELETE' });
          if (!resp.ok) throw new Error('Erro ao excluir');
          Swal.fire('Excluído!', 'Endereço removido com sucesso.', 'success');
          const list = await fetchUserAddresses(localStorage.getItem('bgHouse_whatsapp'));
          renderAddressList(list);
        } catch {
          Swal.fire('Erro', 'Não foi possível excluir o endereço.', 'error');
        }
      }
    }

    // Editar endereço
    function editAddress(id) {
      window.location.href = `edit-address.html?addressId=${id}`;
    }
  </script>
</body>
</html>
